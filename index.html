<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Taquería El Servidor Público</title>
</head>
<body>

  <h1>Ventas Taquería</h1>

  <label for="producto">Producto:</label>
  <select id="producto">
    <option value="picada">Taco de Picada - $14</option>
    <option value="maciza">Taco de Maciza - $15</option>
    <option value="lengua">Taco de Lengua - $17</option>
    <option value="lonchePicada">Lonche de Picada - $40</option>
    <option value="loncheMaciza">Lonche de Maciza - $45</option>
    <option value="loncheLengua">Lonche de Lengua - $50</option>
    <option value="refrescoChico">Refresco Chico - $15</option>
    <option value="refrescoGrande">Refresco Grande - $18</option>
    <option value="agua">Agua de Sabores - $15</option>
  </select>
  <br/>

  <label for="cantidad">Cantidad:</label>
  <input type="number" id="cantidad" min="1" />
  <br/>

  <label for="pago">Pago:</label>
  <input type="number" id="pago" min="0" step="0.01" />
  <br/>

  <label for="fecha">Fecha:</label>
  <input type="date" id="fecha" />
  <br/>

  <button onclick="agregarVenta()">Agregar Venta</button>

  <h2>Resultado</h2>
  <p>Total: $<span id="total">0.00</span></p>
  <p>Cambio: $<span id="cambio">0.00</span></p>

  <h2>Historial de Ventas</h2>
  <table border="1">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="tabla-ventas"></tbody>
  </table>
  <br/>

  <button onclick="borrarHistorial()">Borrar Historial</button>

  <h2>Exportar ventas</h2>
  <label for="fechaInicio">Fecha inicio:</label>
  <input type="date" id="fechaInicio" />
  <label for="fechaFin">Fecha fin:</label>
  <input type="date" id="fechaFin" />
  <button onclick="exportarExcel()">Exportar a Excel</button>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    let ventas = JSON.parse(localStorage.getItem("ventas")) || [];

    const precios = {
      picada: 14,
      maciza: 15,
      lengua: 17,
      lonchePicada: 40,
      loncheMaciza: 45,
      loncheLengua: 50,
      refrescoChico: 15,
      refrescoGrande: 18,
      agua: 15
    };

    function actualizarTabla() {
      const tabla = document.getElementById("tabla-ventas");
      tabla.innerHTML = "";

      ventas.forEach(venta => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${venta.fecha}</td>
          <td>${venta.producto}</td>
          <td>${venta.cantidad}</td>
          <td>$${venta.precio.toFixed(2)}</td>
          <td>$${venta.total.toFixed(2)}</td>
        `;
        tabla.appendChild(fila);
      });
    }

    function agregarVenta() {
      const productoSelect = document.getElementById("producto");
      const cantidadInput = document.getElementById("cantidad");
      const pagoInput = document.getElementById("pago");
      const fechaInput = document.getElementById("fecha");

      const producto = productoSelect.value;
      const cantidad = parseInt(cantidadInput.value);
      const pago = parseFloat(pagoInput.value);
      const fecha = fechaInput.value;

      if (!cantidad || cantidad <= 0) {
        alert("Ingresa una cantidad válida.");
        return;
      }

      if (!pago || pago <= 0) {
        alert("Ingresa un pago válido.");
        return;
      }

      if (!fecha) {
        alert("Selecciona una fecha.");
        return;
      }

      const precio = precios[producto];
      const total = precio * cantidad;

      if (pago < total) {
        alert(`El pago es menor que el total de $${total.toFixed(2)}. Por favor verifica.`);
        return;
      }

      const cambio = pago - total;

      document.getElementById("total").textContent = total.toFixed(2);
      document.getElementById("cambio").textContent = cambio.toFixed(2);

      const venta = { producto, cantidad, precio, total, fecha };
      ventas.push(venta);
      localStorage.setItem("ventas", JSON.stringify(ventas));

      actualizarTabla();

      cantidadInput.value = "";
      pagoInput.value = "";
      fechaInput.value = "";
    }

    function borrarHistorial() {
      if (confirm("¿Estás seguro que quieres borrar el historial de ventas?")) {
        ventas = [];
        localStorage.removeItem("ventas");
        actualizarTabla();

        document.getElementById("total").textContent = "0.00";
        document.getElementById("cambio").textContent = "0.00";
      }
    }

    function exportarExcel() {
      const fechaInicio = document.getElementById("fechaInicio").value;
      const fechaFin = document.getElementById("fechaFin").value;

      if (!fechaInicio || !fechaFin) {
        alert("Selecciona ambas fechas para filtrar.");
        return;
      }

      if (fechaInicio > fechaFin) {
        alert("La fecha inicio debe ser menor o igual que la fecha fin.");
        return;
      }

      const ventasFiltradas = ventas.filter(venta => {
        return venta.fecha >= fechaInicio && venta.fecha <= fechaFin;
      });

      if (ventasFiltradas.length === 0) {
        alert("No hay ventas en el rango seleccionado.");
        return;
      }

      const datosExcel = ventasFiltradas.map(v => ({
        Fecha: v.fecha,
        Producto: v.producto,
        Cantidad: v.cantidad,
        PrecioUnitario: v.precio,
        Total: v.total
      }));

      const worksheet = XLSX.utils.json_to_sheet(datosExcel);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Ventas");

      XLSX.writeFile(workbook, "ventas_filtradas.xlsx");
    }

    window.onload = actualizarTabla;
  </script>

</body>
</html>
